<%= render 'layouts/navbar' %>

<div class="posts-container" style="margin-bottom: 4em; margin-top: 2em;">
  <div style="display: flex; flex-direction: row; justify-content: center;">
    <h1 class="post-title" style="font-size: 3em;">Crea un nuovo Post</h1>
    <%= image_tag "homepage/forum.svg", class: "title-icon" %>
  </div>
  <div id="new-post-form-container" class="new-post-form-container">

      <!-- Colonna sinistra: immagine film -->
      <div id="movie-poster-preview" style="overflow: hidden; flex-shrink:0">
          <img id="movie-poster-img" src="<%= asset_path('post/placeholder.jpg')%>" alt="Poster film" style="overflow: hidden; border-radius:0.5em;" class="blurred">
      </div>

      <!-- Colonna di destra -->
      <div class="new-post-card" style="overflow: visible; border: 0; background-color:rgb(253,116,116, 0.1);">
        <%= form_with model: Post.new, url: posts_path, local: true do |f| %>

          <%# titolo %>
          <div class="post-title field">
            <%= f.label :title, "Titolo",style:"margin-top:0.5em; " %>
            <%= f.text_field :title, class: "form-control limited-width", style:"font-family: 'Inter', sans-serif; width:350px;", autocomplete:"off",required: true %>
          </div>

          <%# contenuto %>
          <div class="post-title field">
            <%= f.label :content, "Cosa ne pensi?" %>
            <%= f.text_area :content, class: "form-control limited-width", style:"font-family: 'Inter', sans-serif; height:140px; resize:none;", autocomplete:"off", required: true %>
          </div>

          <!-- CAMPPO FILM -->
          <div class="post-title field", style="position: relative; margin-bottom: 3em">
            <%= f.label :movie_title, "Titolo del film" %>
            <%= f.text_field :movie_title, class: "form-control limited-width", id: "movie_title_input", style:"font-family: 'Inter', sans-serif; width:350px;", autocomplete: "off", required: true %>
            <%= f.hidden_field :movie_id, id: "movie_id_input" %>
            <%= f.hidden_field :movie_poster_path, id: "movie_poster_path_input" %>
            <div id="movie-suggestions" class="movie-suggestion"></div>
          </div>

          <div class="post-actions" >
            <%= link_to 'Annulla', posts_path, class:"btn forum-button2"%>
            <%= f.submit "Pubblica", class: "btn forum-button2" %>
          </div>
        <% end %>
      </div>
  </div>
</div>

<div class="container-fluid d-flex align-items-center">
    <h1 class="px-2 pt-2 titolo"><b>Top 10 Film</b></h1>
    <%= image_tag "homepage/trend.svg", class: "icon" %>
</div>

<div class="netflix-slider mb-3">
    <button class="slider-btn btn-top left"><%= image_tag "homepage/freccia.svg", class: "slider_img", style: "transform: rotate(180deg)" %></button>
    <div class="slider-track">
        <% @top_movies.each_with_index do |movie, index| %>
        
            <div class="contenitore contenitore_top10 contenitore-film">
                <a href="/movies/<%= movie['id'] %>"><img class="top10" src="https://image.tmdb.org/t/p/w500<%= movie['poster_path'] %>" alt="<%= movie['title'] %>" >
                <span class="number"><b><%= index + 1 %></b></span></a>
            </div>

        <%end%>
    </div>
    <button class="slider-btn btn-top right"><%= image_tag "homepage/freccia.svg", class: "slider_img" %></button>
</div>

<script>

document.addEventListener('DOMContentLoaded', () => {
  const input = document.getElementById('movie_title_input');
  const suggestions = document.getElementById('movie-suggestions');
  const hiddenMovieId = document.getElementById('movie_id_input');
  const hiddenPosterPath = document.getElementById('movie_poster_path_input');

  let timeout = null;

  input.addEventListener('input', () => {
    clearTimeout(timeout);
    const query = input.value.trim();

    if (query.length < 2) {
      suggestions.style.display = 'none';
      return;
    }

    timeout = setTimeout(() => {
      fetch(`/movies/search?query=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
          suggestions.innerHTML = '';
          if (data.length > 0) {
            data.slice(0, 5).forEach(movie => {
              const item = document.createElement('div');
              item.classList.add('movie-suggestion-item');

              const poster = document.createElement('img');
              poster.src = movie.poster_path 
                ? `https://image.tmdb.org/t/p/w92${movie.poster_path}`
                : '/assets/images/post/placeholder.jpg';
              poster.alt = movie.title;
              poster.classList.add('movie-suggestion-poster');

              const text = document.createElement('span');
              const year = movie.release_date ? ` (${new Date(movie.release_date).getFullYear()})` : '';
              text.textContent = movie.title + year;

              item.appendChild(poster);
              item.appendChild(text);

              item.addEventListener('click', () => {
                input.value = movie.title;
                hiddenMovieId.value = movie.id;
                hiddenPosterPath.value = movie.poster_path;
                suggestions.style.display = 'none';


                // **AGGIORNA IMMAGINE NELLA COLONNA SINISTRA**
                const posterImg = document.getElementById('movie-poster-img');
                posterImg.classList.remove('blurred');
                if (movie.poster_path) {
                  posterImg.src = `https://image.tmdb.org/t/p/w342${movie.poster_path}`;
                } else {
                  posterImg.src = '/assets/images/post/placeholder.jpg';
                }placeholder
              });

              suggestions.appendChild(item);
            });

            suggestions.style.display = 'block';
          } else {
            suggestions.style.display = 'none';
          }
        });
    }, 300);
  });

  // Impedisce che si possa scrivere titoli di film non validi
  const form = document.querySelector('form');
  form.addEventListener('submit', (event) => {
    const movieId = hiddenMovieId.value.trim();
    if (!movieId) {
      event.preventDefault(); // blocca il submit
      alert("Seleziona un film valido dai suggerimenti.");
    }
  });

  // Nascondi suggerimenti se clicchi fuori
  document.addEventListener('click', (e) => {
    if (!suggestions.contains(e.target) && e.target !== input) {
      suggestions.style.display = 'none';
    }
  });

});

</script>


<%= render 'layouts/footer' %>